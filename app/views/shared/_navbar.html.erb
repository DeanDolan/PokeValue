<%# References:
    - Rails view helpers (link_to, image_tag, current_page?):
      https://guides.rubyonrails.org/action_view_helpers.html
    - Bootstrap navbar + responsive layout:
      https://getbootstrap.com/docs/5.3/components/navbar/
    - Fetch API and DOM methods (querySelector, addEventListener, etc.):
      https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API
      https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector
%>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <%# Brand link back to home with a slightly larger logo %>
    <%= link_to "/", class: "navbar-brand d-flex align-items-center gap-2" do %>
      <%= image_tag "pokevaluelogo.png", alt: "PokeValue", class: "pv-navbar-logo" %>
    <% end %>

    <%# Mobile toggle button for collapsing/expanding nav items %>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <%# Main navigation links, with current page highlighted %>
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <%= link_to "Portfolio", "/", class: ["nav-link", (current_page?("/") ? "fw-bold text-dark" : nil)].compact.join(" ") %>
        </li>
        <li class="nav-item"><%= link_to "Sets", sets_path, class: ["nav-link", (current_page?(sets_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %></li>
        <li class="nav-item"><%= link_to "Marketplace", marketplace_path, class: ["nav-link", (current_page?(marketplace_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %></li>
        <li class="nav-item"><%= link_to "Auction", auction_path, class: ["nav-link", (current_page?(auction_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %></li>
        <li class="nav-item"><%= link_to "Raffle", raffle_path, class: ["nav-link", (current_page?(raffle_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %></li>
        <li class="nav-item"><%= link_to "Showcase", showcase_path, class: ["nav-link", (current_page?(showcase_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %></li>
      </ul>

      <style>
        /* Global search dropdown container, toggled via the "open" class */
        #global-search-results{display:none!important;position:absolute;z-index:1050}
        #global-search-results.open{display:block!important}

        /* Bigger logo without making the navbar feel taller */
        .navbar{
          padding-top:0;
          padding-bottom:0;
          min-height:56px; /* keeps bar compact while allowing a taller logo */
        }
        .pv-navbar-logo{
          height:52px;      /* slightly oversized logo for better branding */
          width:auto;
        }

        /* Keep "username is logged in..." on a single line and ellipsise if needed */
        .navbar-user-wrap{
          display:flex;
          align-items:center;
          gap:.35rem;
          flex-wrap:nowrap;
        }
        .navbar-user-text{
          white-space:nowrap;
          font-size:.85rem;
          max-width:260px;
          overflow:hidden;
          text-overflow:ellipsis;
        }
      </style>

      <%# Global search input (sets + products) with dropdown results %>
      <div class="position-relative me-3" style="min-width:340px;">
        <input id="global-search" class="form-control" type="search" placeholder="Search products and sets..." aria-label="Search" autocomplete="off">
        <div id="global-search-results" class="dropdown-menu w-100 mt-1 p-0" aria-labelledby="global-search" style="max-height:420px; overflow:auto;"></div>
      </div>

      <%# MyAccount link â€“ either goes to account page or opens auth modal %>
      <ul class="navbar-nav mb-2 mb-lg-0 me-3">
        <li class="nav-item">
          <% if current_user %>
            <%= link_to "MyAccount", account_path, class: ["nav-link", (current_page?(account_path) ? "fw-bold text-dark" : nil)].compact.join(" ") %>
          <% else %>
            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#authModal">MyAccount</a>
          <% end %>
        </li>
      </ul>

      <%# Right-hand side: user info + logout or Login/Register button %>
      <% if current_user %>
        <div class="navbar-user-wrap">
          <span class="navbar-text navbar-user-text">
            <%= "#{current_user.username} is logged in..." %>
          </span>
          <%= button_to "Logout",
                logout_path,
                method: :delete,
                class: "btn btn-outline-danger btn-sm",
                form: { class: "d-inline mb-0" } %>
        </div>
      <% else %>
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#authModal">
          Login/Register
        </button>
      <% end %>
    </div>
  </div>
</nav>

<script type="module">
  // Cache references to the global search input and dropdown container
  const input  = document.getElementById("global-search");
  const menu   = document.getElementById("global-search-results");

  // Build a single result row for the dropdown from a JSON item
  function row(item) {
    return `
      <a class="dropdown-item py-2" href="${item.href}">
        <div class="d-flex align-items-center">
          <img src="${item.image_url}" alt="" style="width:48px;height:48px;object-fit:contain;margin-right:10px;">
          <div class="flex-grow-1">
            <div class="fw-semibold text-truncate">${item.label}</div>
            <div class="text-muted small text-truncate">${item.subtitle}</div>
          </div>
        </div>
      </a>
    `;
  }

  // Render a titled section (e.g. "Sets" or "Products") inside the dropdown
  function section(title, items) {
    if (!items || items.length === 0) return "";
    return `
      <div class="border-bottom px-3 py-2 fw-semibold text-muted small">${title}</div>
      ${items.map(row).join("")}
    `;
  }

  // Take the JSON response from /search_index.json and render it into the dropdown
  function render(data) {
    const setsHtml     = section("Sets", data.sets || []);
    const productsHtml = section("Products", data.products || []);
    const html = [setsHtml, productsHtml].filter(Boolean).join("");

    if (html) {
      menu.innerHTML = html;
      menu.classList.add("open");
    } else {
      menu.classList.remove("open");
      menu.innerHTML = "";
    }
  }

  // Debounced input handler for the global search bar
  let timer;
  input?.addEventListener("input", (e) => {
    const q = e.target.value.trim();
    clearTimeout(timer);

    // If query is empty, close the dropdown and bail early
    if (!q) {
      menu.classList.remove("open");
      menu.innerHTML = "";
      return;
    }

    // Small debounce so I don't hit the server on every keystroke
    timer = setTimeout(async () => {
      try {
        const resp = await fetch("/search_index.json?q=" + encodeURIComponent(q));
        if (!resp.ok) return;
        const data = await resp.json();
        render(data);
      } catch(_) {
        // If the fetch fails for any reason, just leave the menu as is
      }
    }, 120);
  });

  // Hide dropdown when clicking outside of it
  document.addEventListener("click", (e) => {
    if (!menu.contains(e.target) && e.target !== input) {
      menu.classList.remove("open");
    }
  });

  // Hide dropdown when Turbo navigates or caches the page
  document.addEventListener("turbo:click", () => menu.classList.remove("open"));
  document.addEventListener("turbo:before-cache", () => menu.classList.remove("open"));
</script>
