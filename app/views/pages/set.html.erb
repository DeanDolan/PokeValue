<%
  hidden_exact = [
    "Team Rocket's Moltres ex Ultra Premium Collection",
    "Team Rocket’s Moltres ex Ultra Premium Collection",
    "151 Mini Tin",
    "151 Mini Tin Display"
  ]

  def normalize_name(s)
    s.to_s.strip.downcase.gsub("’", "'")
  end
%>

<div class="container py-3">
  <style>
    .equal-tile{min-height:120px;overflow:visible;}
    .tile-logo{max-height:60px;max-width:100%;height:auto;width:auto;object-fit:contain;}
    .equal-tile .small.text-muted{font-size:0.70rem;line-height:1.2;white-space:nowrap;}
    .equal-tile .fw-semibold{font-size:0.80rem;line-height:1.35;margin-top:2px;padding:0 3px;text-align:center;}

    .urgency-tile.urgency-green  { background-color:#16a34a; color:#ffffff; }
    .urgency-tile.urgency-yellow { background-color:#eab308; color:#111827; }
    .urgency-tile.urgency-orange { background-color:#f97316; color:#111827; }
    .urgency-tile.urgency-red    { background-color:#ef4444; color:#ffffff; }
    .urgency-tile.urgency-brown  { background-color:#92400e; color:#ffffff; }
    .urgency-tile.urgency-black  { background-color:#000000; color:#ffffff; }
    .urgency-tile.urgency-unknown{ background-color:#e5e7eb; color:#111827; }

    .urgency-tile .small.text-muted{color:inherit !important;opacity:.85;}
    .urgency-tile .fw-semibold{font-size:0.72rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  </style>

  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-3 mb-4">
    <div class="col">
      <div class="card h-100 equal-tile d-flex align-items-center justify-content-center text-center p-3">
        <%= image_tag @logo_url, alt: @set_name, class: "tile-logo" %>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 equal-tile d-flex flex-column align-items-center justify-content-center text-center p-3">
        <div class="small text-muted">Era</div>
        <div class="fw-semibold"><%= @era %></div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 equal-tile d-flex flex-column align-items-center justify-content-center text-center p-3">
        <div class="small text-muted">Release Date</div>
        <div class="fw-semibold"><%= @release_date %></div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 equal-tile d-flex flex-column align-items-center justify-content-center text-center p-3">
        <div class="small text-muted">Total Set Value</div>
        <div class="fw-semibold">
          <%= @total_value.present? ? number_to_currency(@total_value, unit: "€") : "€0.00" %>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 equal-tile d-flex flex-column align-items-center justify-content-center text-center p-3">
        <div class="small text-muted">Cards/Secret</div>
        <div class="fw-semibold"><%= (@cards || 0) %>/<%= (@secret || 0) %></div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 equal-tile urgency-tile d-flex flex-column align-items-center justify-content-center text-center p-3 <%= @urgency_class %>">
        <div class="small text-muted">Urgency Level</div>
        <div class="fw-semibold"><%= @urgency_label %></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <% if @products.present? %>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
          <% @products.each do |p| %>
            <%
              n = p[:name].to_s
              next if hidden_exact.any? { |x| normalize_name(x) == normalize_name(n) }
              next if normalize_name(n).include?("team rocket") && normalize_name(n).include?("ultra premium collection")
            %>

            <div class="col">
              <a href="<%= p[:link] %>" class="text-decoration-none">
                <div class="card h-100">
                  <%= image_tag p[:img_url], alt: p[:name], class: "card-img-top", style: "aspect-ratio:4/3;object-fit:cover;" %>
                  <div class="card-body py-2 text-center">
                    <div class="fw-semibold small m-0 text-truncate"><%= p[:name] %></div>
                  </div>
                </div>
              </a>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-muted">No products listed for this set.</div>
      <% end %>
    </div>
  </div>
</div>
